---
title: "INLAjoint"
author: "Denis Rustand"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{INLAjoint}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r ld, echo = FALSE, message = FALSE}
library(INLAjoint)
library(JM) # This package contains the dataset
options(width=120)
```

\newpage

In this vignette we show how to fit various models with the *joint()* function of the `INLAjoint` package.

Contact: INLAjoint@gmail.com

## Datasets for illustrations

### Mayo Clinic Primary Biliary Cirrhosis Data (pbc2)

We use the data of the famous randomized clinical trial of Primary Biliary Cholangitis (PBC) patients where 312 PBC patients were followed at the Mayo Clinic between 1974 and 1988 and received either a placebo or D-penicillamine. These data are publicly available in several software including the R package `JM`. During the follow-up, 140 patients died and 29 patients received a liver transplantation which we consider here as a competing event of death. In addition, repeated measures of various longitudinal markers potentially associated with the disease progression were collected. 

This vignette illustrates how to fit various joint model including multiple longitudinal markers, competing risks of events and multi-state models. The final model illustrated is a joint model for two competing risks of events and 5 longitudinal markers with different distributions as proposed in the application section of the following paper: https://arxiv.org/abs/2203.06256

```{r PBC}
data(pbc2) # dataset
# extract some variable of interest without missing values
Longi <- na.omit(pbc2[, c("id", "years", "status","drug","age", 
                          "sex","year","serBilir","SGOT", "albumin", "edema",
                          "platelets", "alkaline","spiders", "ascites")])
Surv <- Longi[c(which(diff(as.numeric(Longi[,which(colnames(Longi)=="id")]))==1),
                length(Longi[,which(colnames(Longi)=="id")])),-c(7:10, 12:16)]
Surv$death <- ifelse(Surv$status=="dead",1,0) # competing event 1
Surv$trans <- ifelse(Surv$status=="transplanted",1,0) # competing event 2
```

### Bone marrow transplant data (bmt)

Bone marrow transplant study which is available in the package "smcure", it is used to illustrate the mixture cure model (model 9 of the vignette).

```{r setWD, echo=FALSE}
setwd("/home/dr/Documents/PROJECTS/INTERFACE/INLAjointDoc/")
```
## Model 1: Mixed effects regression for a single longitudinal marker

This first model shows how to call the *joint()* function for a simple linear mixed effects model for a longitudinal marker, it gives the basic structure of the function. The required arguments are:

* `formLong`: formula for the model with the lme4 structure (including random effects in the formula as: (NAME | ID)).

* `dataLong`: Dataset that must contains the variables given in the formula.

* `id`: Name of the variable for grouping (e.g., individuals).

* `timeVar`: Name of the time variable.

* `family`: Distribution of the outcome (e.g., gaussian, poisson, binomial).

The model structure is given by the following equation:

$$\log(serBilir_{ij}) = \beta_0 + b_{i0} + \beta_1year_{ij} + \beta_2drug_{i} + \varepsilon_{ij} \hspace{1cm} \text{(L1)}$$

where $\beta$ are the fixed effects, $b_{i0}$ is an individual random intercept and $\varepsilon_{ij}$ is the residual error term.

```{r M1}
M1 <- joint(formLong = serBilir ~ year + drug + (1|id),
            dataLong = Longi, id = "id", timeVar = "year", 
            family = "lognormal")
```

The summary statistics are available from the `summary` function:
```{r sM1}
summary(M1)
```

If one wishes to get the standard deviations instead of variance parameters, it is possible to switch with the `sdcor` argument of the `summary` function:
```{r sM1_sd}
summary(M1, sdcor=TRUE)
```


The log marginal-likelihood, the Deviance Information Criterion (DIC) and the Widely Applicable Bayesian Information Criterion (WAIC) are provided in the summary statistics. 

The `control` argument in the `joint` function has the following components:

* `int.strategy` allows to choose the strategy for the numerical integration used to approximate the marginal posterior distributions of the latent field. Available options are "ccd" (default), "grid" or "eb" (empirical Bayes). The empirical Bayes uses only the mode of the approximations for the integration, which speed up and simplifies computations.

* `priorFixed` allows to set the mean and standard deviation of the Gaussian prior for the fixed effects.

* `priorAssoc` allows to set the mean and standard deviation of the Gaussian prior for the association parameters between the longitudinal and survival submodels.

* `cpo` set to TRUE to compute the Conditional Predictive Ordinate.

An useful function to learn about the priors used in a fitted model is `priors.used`, applied to an object fitted with the `joint` function. The default priors are Gaussian with mean zero and scale 1.

```{r priorsM1}
priors.used(M1)
```

The full list of the arguments is available in the help documentation of the `joint` function which can be accessed by running `?joint`.


## Model 2: Multiple longitudinal markers with different distributions

The following code fits a joint model with 3 longitudinal markers including fixed effects for covariates such as sex, drug and interactions with time. We assume random intercept and random slope for each longitudinal trajectory. Note that the `formLong` argument is now a list of formulas, one for each longitudinal marker and the length of family must match the number of markers.

The model structure is given by the following equation:

$$\left\{
\begin{array}{ l @{{}{}} l  @{{}{}} r }\log(serBilir_{ij}) &= \beta_{10} + b_{i10} + (\beta_{11} + b_{i11})year_{ij} + \beta_{12}drug_{i} + \beta_{13}sex_i + \beta_{14}year_{ij}drug_{i} + \varepsilon_{ij1} & \text{(L1)}\\
\log(E[platelets_{ij}]) &= \beta_{20} + b_{i20} + (\beta_{21} + b_{i21})year_{ij} + \beta_{22}sex_i + \beta_{23}drug_{i} + \beta_{24}year_{ij}sex_{i} & \text{(L2)}\\
\text{logit}(E[spiders_{ij}]) &= \beta_{30} + b_{i30} + (\beta_{31} + b_{i31})year_{ij} + \beta_{32}drug_{i} + \beta_{33}year_{ij}drug_{i} & \text{(L3)}
\end{array}
\right.$$

```{r M2}
M2 <- joint(formLong = list(serBilir ~ year * drug + sex  +  (1+year|id),
                            platelets ~ year * sex  +  drug + (1+year|id),
                            spiders ~ year + drug + (1+year| id)),
            dataLong = Longi, id = "id", timeVar="year", corLong=TRUE,
            family = c("lognormal", "poisson", "binomial"), control=list(int.strategy="eb"))
summary(M2)
```

The additional boolean argument `corLong` is set to TRUE in order to have correlation between the random effects accross the longitudinal markers. Therefore by switching this argument to TRUE, instead of having 3 sets of two correlated random effects, we have 1 set of 6 correlated random effects.

We can also get the standard deviation and correlation of random parameters instead of variance and covariance by adding `sdcor=TRUE` to the summary function call:

```{r sM2}
summary(M2, sdcor=TRUE)
```
The link functions between the linear predictors and the longitudinal outcomes are set to default, it is however possible to switch to alternative ones using the `link` argument, e.g., to switch from `logit` to `probit` for the binary marker:

```{r M2_2}
M2 <- joint(formLong = list(serBilir ~ year * drug + sex  +  (1+year|id),
                            platelets ~ year * sex  +  drug + (1+year|id),
                            spiders ~ year + drug + (1+year| id)),
            dataLong = Longi, id = "id", timeVar="year", corLong=TRUE,
            family = c("lognormal", "poisson", "binomial"), 
            link = c("default", "default", "probit"), control=list(int.strategy="eb"))
summary(M2)
```

## Model 3: Proportional hazards survival model

Some additional arguments are introduced to fit a survival model:

* `formSurv`: formula for the time-to-event outcome, with the response given as an inla.surv() object.

* `dataSurv`:  Dataset that must contains the variables given in the formula. When fitting a joint model with a longitudinal component, if dataSurv is not provided, the longitudinal dataset is used to get the covariates values included in the time-to-event formula.

* `basRisk`: the baseline risk of event. It can be defined as parametric with either "exponentialsurv" for exponential baseline or "weibullsurv" for Weibull baseline. Alternatively, there are two options to avoid parametric assumptions on the shape of the baseline risk: "rw1" for random walks of order one prior that corresponds to a smooth spline function based on first order differences. The second option "rw2" assigns a random walk order two prior that corresponds to a smooth spline function based on second order differences. This second option provides a smoother spline compared to order one since the smoothing is then done on the second order. The number of bins that define the intervals for the baseline risk can be specified with `NbasRisk` (default 15 bins).

The model is defined as:
$$\lambda_{i}(t)=\lambda_{0}(t)\ \textrm{exp}\left(\gamma_1drug_i + \gamma_2sex_i +\gamma_3drug_isex_i\right)$$

```{r M3}
DTH <- inla.surv(time = Surv$years, event = Surv$death) # survival outcome
M3 <- joint(formSurv = DTH ~ drug * sex, dataSurv = Surv)
summary(M3)
```
Note that the parameter associated to the baseline risk of event "Baseline risk (variance)" corresponds to the variance parameter associated to the random walk to capture the evolution over time. Summary statistics of the random walks baseline risks are available in the "BaselineValues" attribute of an INLAjoint object. 

It is possible to convert summary statistics to have hazards ratios instead of the mean parameter values in the linear predictor (does not affect baseline parameters). 

```{r M3_2}
summary(M3, hazr=TRUE)
```

Results are similar to the coxph function fit from survival:
```{r M3s}
survival::coxph(Surv(years, death) ~ drug * sex, data = Surv)
```

## Model 4: Longitudinal - survival joint model

An additional argument is required to set up the association between the longitudinal and survival parts:

* `assoc`: a character string that specifies the association between the longitudinal and survival components. The available options are "CV" for sharing the current value of the linear predictor, "CS" for the current slope, "CV_CS" for the current value and the current slope, "SRE" for shared random effects (i.e., sharing the individual deviation from the mean at time t as defined by the random effects), "SRE_ind" for shared random effect independent (each random effect's individual deviation is associated to an association parameter in the survival submodel) and "" (empty string) for no association.

The model structure is given by the following equation:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }log(serBilir_{ij}) &= \eta_{i}(t_{ij}) + \varepsilon_{ij}  & \text{(L1)}\\
&= \beta_0 + \beta_1year_{ij} + (\beta_2 + b_{i2})year_{ij}^2 \\
& \ \ \  + (\beta_3 + b_{i3})year_{ij}^3 + \beta_4drug_{i} + \beta_5year_{ij}drug_{i}\\
& \ \ \ + \beta_6year_{ij}^2drug_{i} + \beta_7year_{ij}^3drug_{i} + \varepsilon_{ij}\\
\lambda_{i1}(t)&=\lambda_{01}(t)\ \textrm{exp}\left(\gamma_1drug_i + \varphi_1\eta_{i}(t) + \varphi_2\eta_{i}'(t)\right) & \text{(S1)}
\end{array}
\right.$$

where $\gamma$ denotes fixed effects of the survival part and $\varphi$ the association parameters.

```{r M4}
# Set up quadratic and cubic functions of time
f1 <- function(x) x^2
f2 <- function(x) x^3

M4 <- joint(formSurv = DTH ~ drug,
            formLong = serBilir ~ (1 + year + f1(year) + f2(year))*drug +
                       (f1(year) + f2(year) |id), family = "lognormal",
            dataLong = Longi, id = "id", timeVar = "year", assoc = "CV_CS",
            basRisk = "rw2", NbasRisk=25, control=list(int.strategy="eb"))
summary(M4)						 
```

In case some functions of time should be included, they must be set as illustrated in the above example, i.e., create a univariate function of x named f1, f2, ..., fN, and use this function in the formula (where N=20 is the maximum number of functions available at the moment but could be increased if needed.). This is important to be able to compute the value of the linear predictor at any time t, particularly for the time-dependent association structures. A numerical approximation of the derivative of the function is automatically computed in case the current slope of the linear predictor is shared in the survival submodel.

We can plot the posterior distribution for all the parameters with the `plot` function

```{r M4plot, echo=TRUE, fig.height=3, fig.width=7}
plotM4 <- plot(M4, sdcor=T)
```

The plot function returns multiple plots for each component of the model. First the plots for the longitudinal outcome(s) parameters:

```{r M4plotL, echo=TRUE, fig.height=5, fig.width=7}
plotM4$Outcomes$L1
```

Then the parameters of the survival outcome(s):

```{r M4plotS, echo=TRUE, fig.height=3, fig.width=7}
plotM4$Outcomes$S1
```

The variance-covariance of the random-effects (converted to standard deviations and correlations when argument `sdcor=TRUE` is added to the call of the plot function):

```{r M4plotC, echo=TRUE, fig.height=5, fig.width=8}
plotM4$Covariances
```

The posterior distributions of the association parameters:

```{r M4plotA, echo=TRUE, fig.height=3, fig.width=7}
plotM4$Associations
```

And finally the curve for the baseline risk functions:

```{r M4plotB, echo=TRUE, fig.height=3, fig.width=7}
plotM4$Baseline
```

The model for the baseline risk is a random walk with number of bins given by argument `NbasRisk`, the curve plotted is linear between the bins but converges towards a smooth spline when the number of bins increase. Sometimes the scale for the baseline hazard risk may require to have a log10 y-axis, this can easily be done using to the `ggplot2` framework. Moreover, the data associated to each plot is available in the object that contains the result of the plot function call (i.e., `PlotM4` in the example).

```{r M4plotB2, echo=TRUE, fig.height=3, fig.width=7}
plotM4$Baseline + scale_y_log10() + geom_abline(slope=0, intercept=0, linetype='dashed')
```

## Model 5: Comparison with MCMC

We can make a comparison of `INLAjoint` with Bayesian estimations with MCMC implemented in alternative R packages such as `JMBayes` (JAGS) or `rstanarm` (Stan).

We propose a comparison for a simple joint model with one longitudinal and one survival component:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }albumin_{ij} &= \eta_{i}(t_{ij}) + \varepsilon_{ij}  & \text{(L1)}\\
&= \beta_0 + b_{i0} + (\beta_1 + b_{i1})year_{ij} + \beta_2drug_{i} + \beta_3year_{ij}drug_{i} + \varepsilon_{ij}\\
\lambda_{i}(t)&=\lambda_{0}(t)\ \textrm{exp}\left(\gamma_{1}sex_i + \gamma_{2}drug_i + \varphi\eta_{i}(t)\right)  & \text{(S1)}
\end{array}
\right.$$

```{r M5}
# INLAjoint
M5 <- joint(formSurv = DTH ~ sex + drug,
            formLong = albumin ~ (1 + year)*drug + (1 + year |id),
            dataLong = Longi, id = "id", timeVar = "year",
            assoc = "CV", control=list(priorFixed=list(mean=0, prec=0.16,
                                  mean.intercept=0, prec.intercept=0.16),
                                  priorAssoc=list(mean=0, prec=0.16)))
summary(M5)
```

Here the prior distributions of the fixed effects and association parameters are changed to have precision 0.16 (i.e., variance 6.25 instead of the default value of 100), in order to match the default prior distributions of `rstanarm` for the fixed effects and association parameters.

```{r M5JMB}
# JMBayes
library(JMbayes)
M5JMB_lme <- lme(albumin ~ (1 + year)*drug,
                  random = ~ 1 + year |id, data = Longi)
M5JMB_cox <- coxph(Surv(Surv$years, Surv$death) ~ sex + drug,
                   data = Surv, x = TRUE)
JMpr = list(priorMean.alphas=0, priorTau.alphas = matrix(0.16))
M5JMB <- jointModelBayes(M5JMB_lme, M5JMB_cox, timeVar = "year", priors=JMpr)
# Computation time in the table includes LME + Cox + JM
Summary(M5JMB)
```

```{r M5rstanarm}
# rstanarm
library(rstanarm)
library(survival)
options(mc.cores = parallel::detectCores())
M5rstanarm <- stan_jm(
  formulaLong = list(albumin ~ (1 + year)*drug + (1 + year |id)),
  formulaEvent = Surv(years, death) ~ sex + drug,
  dataLong = Longi, dataEvent = Surv,
  time_var = "year",
  priorLong_intercept = normal(0, 2.5, autoscale=TRUE),
  priorLong = normal(0, 2.5),
  priorEvent_assoc = normal(0, 2.5),
  seed = 12345)
summary(M5rstanarm)
```

```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|  Package   | INLAjoint |  JMbayes  | rstanarm  |
|------------|-----------|-----------|-----------|
| algorithm  |    INLA   | JAGS MCMC | Stan MCMC |
| comp. time |   5 sec.  |  109 sec. | 596 sec.  |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

A more detailed comparison between INLA and MCEM and MCMC is available at https://arxiv.org/abs/2203.06256 and a comparison between INLA and Levenberg-Marquardt algorithm (Newton-Raphson like that performs MLE) is available at https://arxiv.org/abs/2010.13704

## Model 6: Joint with one longitudinal and competing risks of event

In order to account for competing risks of event, the `formSurv` argument is given as a list with one element for each risk submodel. Moreover, the `basRisk` argument must be a vector with the same number of elements as the number of survival submodels.

The model structure is given by the following equation:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }\log(serBilir_{ij}) &= \eta_{i}(t_{ij}) + \varepsilon_{ij}  & \text{(L1)}\\
&= \beta_0 + b_{i0} + (\beta_1 + b_{i1})year_{ij} + \beta_2drug_{i} + \beta_3sex_i \\
& \ \ \ + \beta_4year_{ij}drug_{i} + \beta_5year_{ij}sex_{i} + \varepsilon_{ij}\\
\lambda_{i1}^{death}(t)&=\lambda_{01}(t)\ \textrm{exp}\left(\gamma_{11}sex_i + \gamma_{12}drug_i + \varphi_{11}(b_{i0} + b_{i1}t)\right)  & \text{(S1)}\\
\lambda_{i2}^{transpl.}(t)&=\lambda_{02}(t)\ \textrm{exp}\left(\gamma_{21}edema\_no_i + \gamma_{22}edema\_de_i + \gamma_{23}sex_i \right.\\
&\left. \ \ + \gamma_{24}edema\_no_isex_i + \gamma_{25}edema\_de_isex_i + \varphi_{21}b_{i0} + \varphi_{22}b_{i1}\right)  & \text{(S2)}
\end{array}
\right.$$

```{r M6}
# set up competing time-to-event outcome
TSP <- inla.surv(time = Surv$years, event = Surv$trans) 

M6 <- joint(formLong = serBilir ~ year * (drug + sex) + (1+year|id), dataLong = Longi, 
            formSurv = list(DTH ~ sex + drug,
                            TSP ~ edema * sex),
            id = "id", timeVar = "year", family = "lognormal", basRisk = c("rw1", "rw1"), 
            assoc = c("SRE", "SRE_ind"), control=list(int.strategy="eb"))
summary(M6)
```

## Model 7: Joint with three longitudinal markers and competing risks of event

When multiple longitudinal submodels and survival submodels are included, the arguments `formSurv` and `formLong` are both given as lists. The `assoc` parameter should then be a list with one element for each longitudinal submodel and each element is a vector for the association with each survival submodel.

The model structure is given by the following equation:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }\log(serBilir_{ij}) &= \eta_{i1}(t_{ij}) + \varepsilon_{ij1} = \beta_{10} + b_{i10} + (\beta_{11} + b_{i11})year_{ij} + \beta_{12}drug_{i} + \beta_{13}sex_i & \text{(L1)} \\
& \ \ \ + \beta_{14}year_{ij}drug_{i} + \varepsilon_{ij1}\\
\log(E[platelets_{ij}]) &= \eta_{i2}(t_{ij}) = \beta_{20} + b_{i20} + (\beta_{21} + b_{i21})year_{ij} + \beta_{22}sex_i + \beta_{23}drug_{i} + \beta_{24}year_{ij}sex_{i} & \text{(L2)}\\
\text{logit}(E[spiders_{ij}]) &= \eta_{i3}(t_{ij}) = \beta_{30} + b_{i30} + (\beta_{31} + b_{i31})year_{ij} + \beta_{32}drug_{i} + \beta_{33}year_{ij}drug_{i}  & \text{(L3)}\\
\lambda_{i1}(t)&=\lambda_{01}(t)\ \textrm{exp}\left(\gamma_{11}drug_i + \varphi_{11}\eta_{i1}(t) + \varphi_{12}(b_{i20} + b_{i21} t) + \varphi_{13}\eta_{i3}(t) + \varphi_{14}\eta_{i3}'(t)\right) & \text{(S1)}\\
\lambda_{i2}(t)&=\lambda_{02}(t)\ \textrm{exp}\left(\gamma_{21}drug_i + \varphi_{21}\eta_{i1}(t) + \varphi_{22}\eta_{i3}'(t)\right)  & \text{(S2)}
\end{array}
\right.$$

```{r M7}
M7 <- joint(formLong = list(serBilir ~ year * drug + sex  +  (1|id),
                            platelets ~ year + f1(year) + drug  +  sex + (1|id),
                            albumin ~ year + f1(year) + f2(year) + drug + (1|id)),
            formSurv = list(DTH ~ drug,
                            TSP ~ drug),
            dataLong = Longi, id = "id", corLong=TRUE, timeVar = "year", 
            family = c("lognormal", "poisson", "gaussian"), basRisk = c("rw1", "rw1"),
            assoc = list(c("CV", "CV"), c("SRE", ""), c("CV_CS", "CS")),
            control=list(int.strategy="eb"))
summary(M7)
```

The longitudinal markers are assumed correlated but it is also possible to set `corLong` to FALSE to have independent random effects accross markers and reduce the number of covariance parameters.



## Model 8: Multi-state model

For the multi-state model, we need to define a survival model for each transition. Here for example in the case of illness-death we have three possible transitions: 1->2, 1->3 and 2->3.

The model structure is given by the following equation:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }
\lambda_{i,12}(t)&=\lambda_{0,12}(t)\ \textrm{exp}\left(\gamma_{12}X_i\right) & \text{(S1)}\\
\lambda_{i,13}(t)&=\lambda_{0,13}(t)\ \textrm{exp}\left(\gamma_{13}X_i\right)  & \text{(S2)}\\
\lambda_{i,23}(t)&=\lambda_{0,23}(t)\ \textrm{exp}\left(\gamma_{23}X_i\right)  & \text{(S3)}
\end{array}
\right.$$

Note that the baseline risk function is transition-specific (one baseline risk for each survival model).

```{r M8}
# set up outcomes for each transition
data(SurvMS) # load small simulated dataset for multi-state
E12 <- inla.surv(time = SurvMS[[1]]$Tstop, event = SurvMS[[1]]$status) # transition 1->2
E13 <- inla.surv(time = SurvMS[[2]]$Tstop, event = SurvMS[[2]]$status) # transition 1->3
E23 <- inla.surv(time = SurvMS[[3]]$Tstop, truncation=SurvMS[[3]]$Tstart, 
                 event =SurvMS[[3]]$status) # transition 2->3

M8 <- joint(formSurv=list(E12 ~ X, E13 ~ X, E23 ~ X), 
            basRisk = c("rw2", "rw2", "rw2"), dataSurv = SurvMS)
summary(M8)
```


## Model 9: Joint longitudinal and multi-state model

We can extend the previous model to joint longitudinal and multi-state. The model structure is given by the following equation:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }
Y_{ij} &= \eta_{i}(t_{ij}) + \varepsilon_{ij} = \beta_{0} + b_{i0} + (\beta_{1} + b_{i1})time_{ij} + \beta_{12}X_{i}  + \varepsilon_{ij} & \text{(L1)} \\
\lambda_{i,12}(t)&=\lambda_{0,12}(t)\ \textrm{exp}\left(\gamma_{12}X_i + \varphi_{12}\eta_{i}(t)\right) & \text{(S1)}\\
\lambda_{i,13}(t)&=\lambda_{0,13}(t)\ \textrm{exp}\left(\gamma_{13}X_i + \varphi_{13}\eta_{i}(t)\right)  & \text{(S2)}\\
\lambda_{i,23}(t)&=\lambda_{0,23}(t)\ \textrm{exp}\left(\gamma_{23}X_i + \varphi_{23}\eta_{i}(t)\right)  & \text{(S3)}
\end{array}
\right.$$

```{r M9}
data(LongMS) # load longitudinal data for joint longitudinal and multi-state
M9 <- joint(formSurv=list(E12 ~ X, E13 ~ X, E23 ~ X), 
            formLong=list(y ~ time + X + (1+time|id)),
            basRisk = c("rw2", "rw2", "rw2"), timeVar = "time", 
            assoc = list(c("CV", "CV", "CV")), id="id", 
            dataSurv = SurvMS, dataLong = LongMS)
summary(M9)
```



## Model 10: Mixture cure model

The mixture cure model is used to analyze survival data with a cure fraction. The cured patients are subject to no excess risk and the uncured patients are subject to excess risk modeled using a parametric survival distribution. Let p(C=1) denote the probability of being cured and $\lambda_{i}(t|C=0)$ the survival for the part of the population that is not cured, the mixture cure model is defined by:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }
\textrm{Logit}(p(C=1)) &= \beta_{0} + \beta_{1}X_{i} & \text{(probability of being cured)} \\
\lambda_{i}(t|C=0)&=\lambda_{0}(t)\ \textrm{exp}\left(\gamma X_i\right) & \text{(survival for non-cured)}
\end{array}
\right.$$

\textit{Note: the survival function for cured patients is always equal to 1 and the limit of the population survival $S(t)$ converges to $p(C=1)$ when $t\rightarrow\infty$.}

The mixture cure model can be added to any survival model and can deal with left, right and interval censoring. However, only parametric baseline risks can be defined at the moment for mixture cure models and the covariates that affect the probability of being cured can be associated to fixed effects only (i.e., no random effects in the logistic part). 


```{r M10}
library("smcure")
data("bmt")
MC_DTH <- inla.surv(time = bmt$Time, event = bmt$Status, 
                    cure=cbind("Int"=1, "TRT"=bmt$TRT))
M10 <- joint(formSurv=MC_DTH ~ TRT, basRisk = "weibullsurv", 
            dataSurv = bmt, control=list(variant=0))
summary(M10)
```

## Model 11: Shared frailty model for recurrent events

The frailty model can fit recurrent events with a lognormal distribution for the frailty term.

$$\lambda_{i}(t)=\lambda_{0}(t)\ \omega_i \  \textrm{exp}\left(\gamma_{1}Sex_i + \gamma_{2}Age_i\right)$$
$$\omega_i \sim log\mathcal{N}(\mu, \sigma^2)$$
```{r M11}
library(survival)
rec <- inla.surv(time = kidney$time, event = kidney$status)
M11 <- joint(formSurv=rec ~ sex + age + (1|id), id="id", dataSurv = kidney)
summary(M11)
```

We can compare the results with the coxph function from survival package:

```{r M11s}
M11s <- coxph(Surv(time, status) ~ sex + age + frailty.gaussian(id), data = kidney)
summary(M11s)
```


## Model 12: Two-part model for a semicontinuous outcome

The two-part model is used to fit a semicontinuous outcome, usually zero-inflated but a point mass other than zero can also be handled. It includes a logistic mixed effects model for a binary outcome (zero vs. positive) and a linear mixed effects model for the positive-only values (can be a Poisson model for count or any other distribution available). We illustrate with an example based on PBC by making a fake zero-inflated outcome based on the albumin outcome.

The model structure is given by:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }\textrm{Logit}(Prob(albumin_{ij}>0)) &= \beta_{10} + b_{i10} + (\beta_{11} + b_{i11})year_{ij} + \beta_{12}drug_{i} + \beta_{13}year_{ij}drug_{i}  & \text{(L1)}\\
\textrm{E}[albumin_{ij}|albumin_{ij}>0] &= \beta_{20} + b_{i20} + (\beta_{21} + b_{i21})year_{ij} + \beta_{22}drug_{i} + \beta_{23}year_{ij}drug_{i} + \varepsilon_{ij}  & \text{(L2)}\\
\end{array}
\right.$$

```{r M12}
# make a zero-inflated continuous outcome for illustration
Longi$binary <- ifelse(Longi$albumin<3, 0, 1)
# dataset with only positives for the continuous part
LongiPositive <- Longi[which(Longi$albumin>=3),]
M12 <- joint(formLong = list(binary ~ year * drug +  (1+year|id),
                             albumin ~ year * drug + (1+year|id)),
             dataLong = list(Longi, LongiPositive), timeVar="year", 
             id = "id", family = c("binomial", "gaussian"), corLong=TRUE)
summary(M12)
```

## Model 13: Two-part joint model for a semicontinuous outcome and a terminal event

We can fit a joint two-part model by adding a survival component to the previous model. The association is based on shared random effects (each random effect is shared in the survival submodel and associated to a scaling parameter). Simulation studies for this model are available at https://arxiv.org/abs/2010.13704

The model structure is given by:

$$\left\{
\begin{array}{ c @{{}{}} l  @{{}{}} r }\textrm{Logit}(Prob(albumin_{ij}>0)) &= \beta_{10} + b_{i10} + (\beta_{11} + b_{i11})year_{ij} + \beta_{12}drug_{i} + \beta_{13}year_{ij}drug_{i}  & \text{(L1)}\\
\textrm{E}[albumin_{ij}|albumin_{ij}>0] &= \beta_{20} + b_{i20} + (\beta_{21} + b_{i21})year_{ij} + \beta_{22}drug_{i} + \beta_{23}year_{ij}drug_{i} + \varepsilon_{ij}  & \text{(L2)}\\
\lambda_{i}(t)&=\lambda_{0}(t)\ \textrm{exp}\left(\gamma_{1}drug_i + \varphi_1b_{i10} + \varphi_2b_{i11} + \varphi_3b_{i20} + \varphi_4b_{i21}\right)  & \text{(S1)}
\end{array}
\right.$$

```{r M13}
M12 <- joint(formLong = list(binary ~ year * drug +  (1+year|id),
                             albumin ~ year * drug + (1+year|id)),
             formSurv = DTH ~ drug,
             dataLong = list(Longi, LongiPositive), timeVar="year", 
             id = "id", corLong=TRUE, assoc = c("SRE_ind", "SRE_ind"),
             family = c("binomial", "gaussian"))
summary(M13)
```


## Model 14: Joint model for multivariate longitudinal data and competing risks of event (application section of https://arxiv.org/abs/2203.06256)

The model structure is given by the following equation:

$$\left\{
\begin{array}{ l @{{}{}} l  @{{}{}} r }
\log(serBilir_{ij}) &= \eta_{i1}(t_{ij}) + \varepsilon_{ij1}  & \text{(L1)}\\
&=(\beta_{10} + b_{i10})+\beta_{11}X_{i}+(\beta_{12}+b_{i11})\textrm{NS}_1(t_{ij})+(\beta_{13}+b_{i12})\textrm{NS}_2(t_{ij})\\
& \ \ \ + (\beta_{14}+b_{i13})\textrm{NS}_3(t_{ij})+\beta_{15}X_{i}\textrm{NS}_1(t_{ij})+\beta_{16}X_{i}\textrm{NS}_2(t_{ij})+\beta_{17}X_{i}\textrm{NS}_3(t_{ij}) + \varepsilon_{ij1} \\
\log(SGOT_{ij}) &= \eta_{i2}(t_{ij}) + \varepsilon_{ij2}  & \text{(L2)}\\
&= (\beta_{20} + b_{i20})+\beta_{21}X_{i}+(\beta_{22}+b_{i21})\textrm{NS}_1(t_{ij})+(\beta_{23}+b_{i22})\textrm{NS}_2(t_{ij})\\
& \ \ \ + (\beta_{24}+b_{i23})\textrm{NS}_3(t_{ij})+\beta_{25}X_{i}\textrm{NS}_1(t_{ij})+\beta_{26}X_{i}\textrm{NS}_2(t_{ij})+\beta_{27}X_{i}\textrm{NS}_3(t_{ij}) + \varepsilon_{ij2} \\
albumin_{ij}&=\eta_{i3}(t_{ij}) + \varepsilon_{ij3}  & \text{(L3)}\\
&= (\beta_{30} + b_{i30})+\beta_{31}X_{i}+(\beta_{32}+b_{i31})t+\beta_{33}X_{i}t+ \varepsilon_{ij3}\\
\log(\textrm{E}[platelets_{ij}])&=\eta_{i4}(t_{ij})  & \text{(L4)}\\
&= (\beta_{40} + b_{i40})+\beta_{41}X_{i}+(\beta_{42}+b_{i41})\textrm{NS}_1(t_{ij})+(\beta_{43}+b_{i42})\textrm{NS}_2(t_{ij})\\
& \ \ \ + (\beta_{44}+b_{i43})\textrm{NS}_3(t_{ij})+\beta_{45}X_{i}\textrm{NS}_1(t_{ij})+\beta_{46}X_{i}\textrm{NS}_2(t_{ij})+\beta_{47}X_{i}\textrm{NS}_3(t_{ij}) \\
\textrm{logit}(\textrm{E}[spiders_{ij}])&=\eta_{i5}(t_{ij}) & \text{(L5)}\\
&= (\beta_{50} +b_{i50})+\beta_{51}X_{i}+(\beta_{52}+b_{i51})t+\beta_{53}X_{i}t \\
\lambda_{i1}(t)&=\lambda_{01}(t)\ \textrm{exp}\left(\gamma_1 X_i + \varphi_1\eta_{i1}(t) + \varphi_3\eta_{i1}'(t) + \varphi_4\eta_{i2}(t) \right.  & \text{(S1)}\\
& \ \ \ + \left.\varphi_5\eta_{i3}(t) + \varphi_7\eta_{i4}(t) + \varphi_9\eta_{i5}(t) \right) \\
\lambda_{i2}(t)&=\lambda_{02}(t)\ \textrm{exp}\left(\gamma_2 X_i + \varphi_2\eta_{i1}(t) + \varphi_6\eta_{i3}(t) + \varphi_8\eta_{i4}(t) \right)  & \text{(S2)}
\end{array}
\right.$$

where $\textrm{NS}_1(t), \textrm{NS}_2(t), \textrm{NS}_3(t)$ are the natural cubic splines with internal knots at 1 and 4 years. We assume independent random effects between longitudinal markers.

```{r M14}
# set up natural cubic splines for longitudinal markers's trajectories
Nsplines <- ns(Longi$year, knots=c(1,4))
f1 <- function(x) predict(Nsplines, x)[,1]
f2 <- function(x) predict(Nsplines, x)[,2]
f3 <- function(x) predict(Nsplines, x)[,3]

M14 <-joint(formSurv = list(DTH ~ drug, TSP ~ drug),
            formLong = list(serBilir ~ (1 + f1(year) + f2(year) + f3(year)) * drug +
                              (1 + f1(year) + f2(year) + f3(year) | id),
                            SGOT ~ (1 + f1(year) + f2(year) + f3(year)) * drug +
                              (1 + f1(year) + f2(year) + f3(year) | id),
                            albumin ~ (1 + year) * drug + (1 + year | id),
                            platelets ~ (1 + f1(year) + f2(year) + f3(year)) * drug +
                              (1 + f1(year) + f2(year) + f3(year) | id),
                            spiders ~ (1 + year) * drug + (1 + year | id)),
													
            dataLong = Longi, id = "id", timeVar = "year",
            family = c("lognormal", "lognormal", "gaussian", "poisson", "binomial"),
            basRisk = c("rw2", "rw1"), NbasRisk = 15, assoc = list(c("CV_CS", "CV"),
                            c("CV", ""), c("CV", "CV"), c("CV", "CV"), c("CV", "")),
            control=list(int.strategy="eb", cfg=T))
summary(M14)
```


